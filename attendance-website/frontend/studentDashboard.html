<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Dashboard</title>
  <link rel="stylesheet" href="css/studentDashboard.css">
</head>
<body>
  <div class="dashboard-container">
    <div class="header">
      <h2>Student Dashboard</h2>
      <button onclick="logout()" class="btn btn-logout">Logout</button>
    </div>

    <div class="dashboard-content">
      <div class="section">
        <h3>Welcome, <span id="studentName"></span></h3>
        <div class="student-info">
          <p>Roll Number: <span id="rollNumber"></span></p>
          <p>Course: <span id="course"></span></p>
          <p>Year: <span id="year"></span></p>
          <p>Semester: <span id="semester"></span></p>
        </div>
      </div>

      <div class="section">
        <h3>Attendance Record</h3>
        <div id="attendanceRecord"></div>
      </div>
    </div>
  </div>

  <script src="js/main.js"></script>
  <script>
    // Check if userId is present in localStorage
    if (!localStorage.getItem('userId')) {
      window.location.href = 'login.html';
    }

    let student = null;

    // Load student data
    async function loadStudentData() {
      try {
        const userId = localStorage.getItem('userId');
        const res = await fetch(`http://localhost:5000/api/student/dashboard?userId=${userId}`);

        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.message || 'Failed to load student data');
        }

        student = await res.json();

        if (!student) {
          throw new Error('Student not found in database');
        }

        // Update student info
        document.getElementById('studentName').textContent = student.name || '-';
        document.getElementById('rollNumber').textContent = student.roll || '-';
        document.getElementById('course').textContent = student.course || '-';
        document.getElementById('year').textContent = student.year || '-';
        document.getElementById('semester').textContent = student.semester || '-';

        // Load attendance record
        loadAttendanceRecord();
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to load student data: ' + error.message);
      }
    }

    // Load attendance record
    async function loadAttendanceRecord() {
      try {
        const userId = localStorage.getItem('userId');
        const res = await fetch(`http://localhost:5000/api/student/attendance?userId=${userId}`);

        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.message || 'Failed to load attendance');
        }

        const attendance = await res.json();
        const attendanceRecord = document.getElementById('attendanceRecord');

        if (!attendance || attendance.length === 0) {
          attendanceRecord.innerHTML = '<p>No attendance records found</p>';
          return;
        }

        attendanceRecord.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Roll No</th>
                <th>Subject</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${attendance.map(record => `
                <tr>
                  <td>${student.roll}</td>
                  <td>${record.subject || record.course || '-'}</td>
                  <td>${record.status}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('attendanceRecord').innerHTML = '<p>Failed to load attendance record</p>';
      }
    }

    // Load data when page loads
    loadStudentData();
  </script>
  <footer>
    <p>Copyright &copy; 2025 Pratik, Amrish, Kamlesh All Rights Reserved.</p>
  </footer>
</body>
</html>